<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Kairo - List view</title>
  <style>
    * { box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 0; padding: 0; background: #f5f5f5; }
    #header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: space-between; gap: 20px; position: sticky; top: 0; z-index: 100; }
    #header .back-link { color: white; text-decoration: none; opacity: 0.95; margin-right: 20px; font-size: 15px; font-weight: 600; padding: 6px 12px; background: rgba(255,255,255,0.15); border-radius: 8px; white-space: nowrap; flex-shrink: 0; }
    #header .back-link:hover { opacity: 1; background: rgba(255,255,255,0.25); }
    .header-row-one { display: flex; align-items: center; gap: 12px; flex: 1; min-width: 0; }
    .project-switcher { display: flex; align-items: center; gap: 0; }
    .project-switcher label { display: none; }
    .project-switcher select { padding: 0; border-radius: 0; font-size: 18px; cursor: pointer; background: transparent; color: white; border: none; font-weight: 600; min-width: auto; appearance: none; -webkit-appearance: none; -moz-appearance: none; background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: right 2px center; background-size: 18px; padding-right: 24px; }
    .project-switcher select:hover { opacity: 0.9; }
    #stats { display: flex; gap: 20px; font-size: 13px; opacity: 0.9; flex-wrap: wrap; align-items: center; }
    .stat { display: flex; align-items: center; gap: 6px; }
    .stat-value { font-size: 20px; font-weight: bold; }
    #controls { background: white; padding: 20px 30px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; gap: 20px; flex-wrap: wrap; align-items: center; }
    .control-group { display: flex; gap: 10px; align-items: center; }
    label { font-weight: 600; font-size: 14px; }
    input[type="text"] { padding: 8px 12px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px; min-width: 250px; }
    input[type="text"]:focus { outline: none; border-color: #667eea; }
    select { padding: 8px 12px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px; cursor: pointer; }
    input[type="range"] { width: 150px; }
    #container { max-width: 1400px; margin: 0 auto; padding: 30px; }
    #results-info { margin-bottom: 20px; font-size: 14px; color: #666; }
    .component-card { background: white; border-radius: 8px; padding: 20px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); transition: transform 0.2s, box-shadow 0.2s; }
    .component-card:hover { transform: translateY(-2px); box-shadow: 0 4px 16px rgba(0,0,0,0.12); }
    .component-header { display: flex; align-items: center; gap: 15px; margin-bottom: 12px; flex-wrap: wrap; }
    .component-type { padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
    .type-CustomObject { background: #DA70D6; color: white; }
    .type-ApexClass { background: #00BCD4; color: white; }
    .type-ApexTrigger { background: #1565C0; color: white; }
    .type-Flow { background: #9C27B0; color: white; }
    .type-LightningWebComponent { background: #FF9800; color: white; }
    .type-AuraComponent { background: #E65100; color: white; }
    .type-Unknown { background: #757575; color: white; }
    .component-name { font-size: 18px; font-weight: 600; color: #333; flex: 1; }
    .component-connections { font-size: 14px; color: #666; background: #f0f0f0; padding: 4px 12px; border-radius: 12px; }
    .component-label { color: #666; font-size: 14px; margin-bottom: 12px; font-style: italic; }
    .component-details { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee; }
    .detail-section { font-size: 13px; }
    .detail-section strong { display: block; margin-bottom: 8px; color: #333; }
    .dependency-list { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px; }
    .dep-item { background: #f5f5f5; padding: 3px 10px; border-radius: 4px; font-size: 12px; color: #555; border-left: 3px solid transparent; }
    .dep-item.weight-critical { background: #fce4ec; border-left-color: #E91E63; color: #880E4F; font-weight: 600; }
    .dep-item.weight-business { background: #f3e5f5; border-left-color: #9C27B0; color: #4A148C; font-weight: 600; }
    .dep-item.weight-structure { background: #e3f2fd; border-left-color: #2196F3; color: #0D47A1; }
    .dep-item.weight-operations { background: #f5f5f5; border-left-color: #757575; color: #424242; }
    .dep-item.weight-infra { background: #fafafa; border-left-color: #e0e0e0; color: #9e9e9e; }
    .dep-item.used-by { font-weight: 600; }
    .dep-item.used-by.type-CustomObject { background: #f3e5f5; border-left-color: #DA70D6; color: #4a148c; }
    .dep-item.used-by.type-ApexClass { background: #e0f7fa; border-left-color: #00BCD4; color: #0d47a1; }
    .dep-item.used-by.type-ApexTrigger { background: #f1f8e9; border-left-color: #1565C0; color: #0d47a1; }
    .dep-item.used-by.type-Flow { background: #f3e5f5; border-left-color: #9C27B0; color: #4a148c; }
    .dep-item.used-by.type-LightningWebComponent, .dep-item.used-by.type-AuraComponent { background: #fff3e0; border-left-color: #FF9800; color: #e65100; }
    .dep-item.used-by.type-Unknown { background: #f5f5f5; border-left-color: #9e9e9e; color: #616161; }
    .more { color: #667eea; font-size: 12px; font-weight: 600; }
    .hidden { display: none !important; }
    .loading { text-align: center; padding: 60px 20px; font-size: 18px; color: #666; }
    .progress-bar-wrap { width: 100%; max-width: 320px; height: 12px; background: #e0e0e0; border-radius: 6px; overflow: hidden; margin: 16px auto; }
    .progress-bar-fill { height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); border-radius: 6px; transition: width 0.15s ease-out; }
    .progress-text { font-size: 14px; color: #888; margin-top: 8px; }
    .error { background: #fef2f2; color: #dc2626; padding: 20px; border-radius: 8px; margin: 20px; }
  </style>
</head>
<body>
  <div id="header">
    <div class="header-row-one">
      <a href="./" class="back-link" title="Tornar a la homepage">‚Üê Tornar</a>
      <div class="project-switcher">
        <select id="project-select" title="Tria el projecte Salesforce a visualitzar"></select>
      </div>
    </div>
    <div id="stats" style="display: none;"></div>
  </div>
  <div id="controls" style="display: none;"></div>
  <div id="container">
    <div id="loading" class="loading">
      <span>Analitzant projecte Salesforce‚Ä¶</span>
      <div class="progress-bar-wrap"><div id="progress-fill" class="progress-bar-fill" style="width: 0%;"></div></div>
      <div id="progress-text" class="progress-text">0 / 0 fitxers</div>
    </div>
    <div id="error" class="error" style="display: none;"></div>
    <div id="results-info" style="display: none;"></div>
    <div id="components"></div>
  </div>
  <script>
    const STORAGE_KEY = 'kairo-projects';

    function getProjectsSync() {
      try {
        let stored = localStorage.getItem(STORAGE_KEY);
        if (!stored) {
          const legacy = localStorage.getItem('kairo-datasets');
          if (legacy) {
            localStorage.setItem(STORAGE_KEY, legacy);
            localStorage.removeItem('kairo-datasets');
            stored = legacy;
          }
        }
        if (stored) {
          const parsed = JSON.parse(stored);
          return Array.isArray(parsed) ? parsed : [];
        }
      } catch (e) {}
      return [];
    }

    async function getProjects() {
      const local = getProjectsSync();
      if (local.length > 0) return local;
      try {
        const res = await fetch('/api/projects');
        const data = await res.json();
        const fromApi = (data.projects || data.datasets || []).map(p => ({ id: p.id, name: p.name, source: p.source, components: 0, dependencies: 0 }));
        if (fromApi.length > 0) localStorage.setItem(STORAGE_KEY, JSON.stringify(fromApi));
        return fromApi;
      } catch (e) {}
      return [];
    }

    function escapeHtml(s) {
      if (!s) return '';
      const d = document.createElement('div');
      d.textContent = s;
      return d.innerHTML;
    }

    function getWeightClass(w) {
      if (w >= 9) return 'weight-critical';
      if (w >= 7) return 'weight-business';
      if (w >= 5) return 'weight-structure';
      if (w >= 3) return 'weight-operations';
      return 'weight-infra';
    }

    function renderComponent(comp) {
      const sortedOutgoing = (comp.outgoing || []).slice().sort((a, b) => b.weight - a.weight);
      const sortedIncoming = (comp.incoming || []).slice().sort((a, b) => b.weight - a.weight);
      const outgoingHtml = comp.outgoing?.length ? '<div class="dependency-list">' + sortedOutgoing.slice(0, 10).map(d =>
        '<span class="dep-item ' + getWeightClass(d.weight) + '" title="Weight: ' + d.weight + '">' + escapeHtml((d.id.split(':')[1] || d.id)) + '</span>'
      ).join('') + (comp.outgoing.length > 10 ? '<span class="more">+' + (comp.outgoing.length - 10) + ' more</span>' : '') + '</div>' : '<em>none</em>';
      const incomingHtml = comp.incoming?.length ? '<div class="dependency-list">' + sortedIncoming.slice(0, 10).map(d => {
        const type = (d.id.split(':')[0] || 'Unknown').replace(/\s+/g, '');
        const label = d.id.split(':')[1] || d.id;
        return '<span class="dep-item used-by type-' + type + '" title="' + escapeHtml(type) + '">' + escapeHtml(label) + '</span>';
      }).join('') + (comp.incoming.length > 10 ? '<span class="more">+' + (comp.incoming.length - 10) + ' more</span>' : '') + '</div>' : '<em>none</em>';
      return '<div class="component-card" data-type="' + escapeHtml(comp.type) + '" data-connections="' + (comp.connections || 0) + '">' +
        '<div class="component-header">' +
          '<span class="component-type type-' + escapeHtml(comp.type) + '">' + escapeHtml(comp.type) + '</span>' +
          '<span class="component-name">' + escapeHtml(comp.name) + '</span>' +
          '<span class="component-connections">' + (comp.connections || 0) + ' connections</span>' +
        '</div>' +
        (comp.label ? '<div class="component-label">' + escapeHtml(comp.label) + '</div>' : '') +
        '<div class="component-details">' +
          '<div class="detail-section"><strong>Depends on (' + (comp.outgoing?.length || 0) + '):</strong>' + outgoingHtml + '</div>' +
          '<div class="detail-section"><strong>Used by (' + (comp.incoming?.length || 0) + '):</strong>' + incomingHtml + '</div>' +
        '</div></div>';
    }

    async function loadAndRender() {
      const params = new URLSearchParams(location.search);
      let projectId = params.get('project') || params.get('dataset');
      const projects = await getProjects();

      if (!projectId && projects.length > 0) projectId = projects[0].id;
      if (projects.length > 0) {
        const projectSelect = document.getElementById('project-select');
        if (projectSelect) {
          projectSelect.innerHTML = projects.map(p => '<option value="' + encodeURIComponent(p.id) + '"' + (p.id === projectId ? ' selected' : '') + '>' + escapeHtml(p.name || p.id) + '</option>').join('');
          projectSelect.addEventListener('change', function() {
            window.location.href = 'list.html?project=' + encodeURIComponent(this.value);
          });
        }
      }

      if (!projectId || projects.length === 0) {
        document.getElementById('loading').textContent = 'No hi ha projectes. Afegeix-ne un des de la homepage.';
        document.getElementById('loading').innerHTML = '<p>No hi ha projectes Salesforce. <a href="./">Afegeix-ne un des de la homepage</a>.</p>';
        return;
      }

      const project = projects.find(p => p.id === projectId);
      if (!project) {
        document.getElementById('loading').textContent = 'Projecte no trobat: ' + projectId;
        return;
      }

      const source = project.source;
      if (!source) {
        document.getElementById('loading').textContent = 'El projecte no t√© ruta configurada.';
        return;
      }

      try {
        const res = await fetch('/api/list-data', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ source, id: project.id, name: project.name })
        });
        if (!res.ok) throw new Error('Error ' + res.status);
        if (res.headers.get('Content-Type')?.includes('application/x-ndjson')) {
          const reader = res.body.getReader();
          const decoder = new TextDecoder();
          let buffer = '';
          let data = null;
          while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            buffer += decoder.decode(value, { stream: true });
            const lines = buffer.split('\n');
            buffer = lines.pop() || '';
            for (const line of lines) {
              if (!line.trim()) continue;
              try {
                const obj = JSON.parse(line);
                if (obj.progress) {
                  const pct = obj.progress.total > 0 ? Math.round(100 * obj.progress.processed / obj.progress.total) : 0;
                  const fill = document.getElementById('progress-fill');
                  const text = document.getElementById('progress-text');
                  if (fill) fill.style.width = pct + '%';
                  if (text) text.textContent = obj.progress.processed + ' / ' + obj.progress.total + ' fitxers';
                  await new Promise(r => setTimeout(r, 0));
                } else if (obj.result) {
                  data = obj.result;
                } else if (obj.error) {
                  throw new Error(obj.error);
                }
              } catch (e) {
                if (e instanceof SyntaxError) continue;
                throw e;
              }
            }
          }
          if (!data) throw new Error('No result received');
        } else {
          data = await res.json();
        }

        document.getElementById('loading').style.display = 'none';
        document.getElementById('header').querySelector('#stats').style.display = 'flex';
        document.getElementById('header').querySelector('#stats').innerHTML =
          '<div class="stat"><span>Components:</span><span class="stat-value">' + data.stats.totalComponents + '</span></div>' +
          '<div class="stat"><span>Dependencies:</span><span class="stat-value">' + data.stats.totalDependencies + '</span></div>' +
          '<div class="stat"><span>Objects:</span><span class="stat-value">' + (data.stats.componentsByType?.CustomObject || 0) + '</span></div>' +
          '<div class="stat"><span>Apex:</span><span class="stat-value">' + ((data.stats.componentsByType?.ApexClass || 0) + (data.stats.componentsByType?.ApexTrigger || 0)) + '</span></div>';
        document.getElementById('controls').style.display = 'flex';
        document.getElementById('controls').innerHTML =
          '<div class="control-group"><label for="search">üîç Search:</label><input type="text" id="search" placeholder="Type component name..."></div>' +
          '<div class="control-group"><label for="type-filter">Type:</label><select id="type-filter">' +
          '<option value="all">All Types</option><option value="CustomObject">Custom Objects</option><option value="ApexClass">Apex Classes</option>' +
          '<option value="ApexTrigger">Apex Triggers</option><option value="Flow">Flows</option><option value="LightningWebComponent">LWC</option><option value="AuraComponent">Aura</option>' +
          '</select></div>' +
          '<div class="control-group"><label for="min-conn">Min Connections:</label><input type="range" id="min-conn" min="0" max="20" value="1"><span id="min-conn-value">1</span></div>' +
          '<div class="control-group"><label for="show-process-only"><input type="checkbox" id="show-process-only"> Business Processes (‚â•7)</label></div>';
        document.getElementById('components').innerHTML = (data.components || []).map(renderComponent).join('');
        document.getElementById('results-info').style.display = 'block';

        const allCards = document.querySelectorAll('.component-card');
        const searchInput = document.getElementById('search');
        const typeFilter = document.getElementById('type-filter');
        const minConnSlider = document.getElementById('min-conn');
        const minConnValue = document.getElementById('min-conn-value');
        const resultsInfo = document.getElementById('results-info');

        function applyFilters() {
          const searchTerm = (searchInput?.value || '').toLowerCase();
          const selectedType = typeFilter?.value || 'all';
          const minConn = parseInt(minConnSlider?.value || '1');
          let visibleCount = 0;
          allCards.forEach(card => {
            const name = (card.querySelector('.component-name')?.textContent || '').toLowerCase();
            const type = card.getAttribute('data-type');
            const connections = parseInt(card.getAttribute('data-connections') || '0');
            const ok = (!searchTerm || name.includes(searchTerm)) && (selectedType === 'all' || type === selectedType) && connections >= minConn;
            card.classList.toggle('hidden', !ok);
            if (ok) visibleCount++;
          });
          if (resultsInfo) resultsInfo.textContent = 'Showing ' + visibleCount + ' of ' + allCards.length + ' components';
        }
        searchInput?.addEventListener('input', applyFilters);
        typeFilter?.addEventListener('change', applyFilters);
        minConnSlider?.addEventListener('input', function() { if (minConnValue) minConnValue.textContent = this.value; applyFilters(); });
        document.getElementById('show-process-only')?.addEventListener('change', function() {
          document.querySelectorAll('.dep-item').forEach(item => {
            item.style.display = this.checked && !item.classList.contains('weight-critical') && !item.classList.contains('weight-business') ? 'none' : '';
          });
        });
        applyFilters();
      } catch (err) {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('error').style.display = 'block';
        document.getElementById('error').textContent = 'Error: ' + err.message;
      }
    }
    loadAndRender();
  </script>
</body>
</html>
